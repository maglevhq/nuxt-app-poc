#!/usr/bin/env node
import readdirGlob from 'readdir-glob'
import fs from 'fs'
import Ajv from "ajv"
import { SectionDefinition } from '~~/maglev-core/types'
import { camelize } from '~~/maglev-core/utils'
import SectionJsonSchema from '~~/maglev-core/section-json-schema.json'

console.log("ğŸ‘‹ Hi! We're going to generate the types for your sections\n")

const ajv = new Ajv({ allowUnionTypes: true })
var fileContent = ''
var definitionMapping: string[] = []

const globber = readdirGlob('./maglev', { pattern: '**/*.schema.json' })
globber.on('match', async (match) => {
  process.stdout.write(`processing ${match.relative}...`)

  const rawData = await fs.readFileSync(match.absolute, { encoding: 'utf8', flag: 'r' })
  const data = JSON.parse(rawData)

  const valid = ajv.validate(SectionJsonSchema, data)
  console.log(valid ? 'âœ…' : 'ğŸš¨')
  if (!valid) {
    console.log(ajv.errors)
    throw "Your section definition is not valid"
  }

  const sectionDefinition: SectionDefinition = data
  const sectionName = `${camelize(sectionDefinition.id, true)}Section`

  const blockTypes = sectionDefinition.blocks.map(block => `
export type ${sectionName}${camelize(block.type, true)}Block = {
  id: string
  settings: {${block.settings.map(setting => `
    ${setting.id}: CoreTypes.${camelize(setting.type, true)}Setting`).join('')}
  }
}
`).join('')

  const sectionType = `
export type ${sectionName} = CoreTypes.Section & {
  id: string
  settings: {${sectionDefinition.settings.map(setting => `
    ${setting.id}: CoreTypes.${camelize(setting.type, true)}Setting`).join('')}
  }` + (sectionDefinition.blocks.length > 0 ? `
  blocks: (${sectionDefinition.blocks.map(block => `${sectionName}${camelize(block.type, true)}Block`)})[]` : '') + `
}
`
  definitionMapping.push(`
  ${sectionDefinition.id}: {
    settings: {${sectionDefinition.settings.map(setting => `
      ${setting.id}: '${setting.type}'`).join(',')}
    },
    blocks: {${sectionDefinition.blocks.map(blockDefinition => `
      ${blockDefinition.type}: {
        settings: {${blockDefinition.settings.map(setting => `
          ${setting.id}: '${setting.type}'`).join(',')}
        }
      }`).join(',')}
    }
  }`)

  fileContent = fileContent.concat(sectionType, blockTypes)
})
globber.on('end', () => {  
  const filepath = './maglev/types.ts'
  const content = `
// Generated by Maglev codegen
import * as CoreTypes from '~~/maglev-core/types'
${fileContent}  

const sectionDefinitionMapping: CoreTypes.SectionDefinitionMapping = {${definitionMapping.join(",")}}

export { sectionDefinitionMapping }
`
  fs.writeFile(filepath, content, (err) => {
    if (err) throw err;    
  })

  console.log("\n\nâœ… Types generated ğŸ‰")
})
